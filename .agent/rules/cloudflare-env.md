---
trigger: always_on
---

# Rule: Cloudflare Env Discipline

## Activation

**Always On**

## Purpose

Ensure consistent, correct usage of the globally defined `Env` interface generated by `wrangler types`, and prevent duplication, extension, or redefinition of environment bindings across the codebase.

---

## Source of Truth

- `worker-configuration.d.ts` is the **only valid source of the Env interface**
- It is generated by `npx wrangler types`
- It must **never be manually modified, extended, or patched**

---

## Hard Constraints (Must Follow)

### ✅ Allowed

- Use `env: Env` in all runtime entrypoints and handlers
- Rely on ambient/global typing provided by `worker-configuration.d.ts`
- Regenerate the file using:
  ```bash
  npx wrangler types
  ```

❌ Forbidden
• Creating or reintroducing env.ts
• Extending Cloudflare.Env or re-declaring interface Env
• Importing Env from local files
• Manually editing worker-configuration.d.ts
• Using any, Record<string, unknown>, or ad-hoc env typing

⸻

Framework-Specific Usage

Raw Workers

export default {
fetch(req: Request, env: Env, ctx: ExecutionContext) {
// ✅ Correct
}
}

Hono

const app = new Hono<{ Bindings: Env }>()

Durable Objects

export class MyDO {
constructor(private state: DurableObjectState, private env: Env) {}
}

⸻

Agents SDK Handling

Base Agent

abstract class BaseAgent {
constructor(protected env: Env) {}
}

Sub-Agent

class EmailAgent extends BaseAgent {
send() {
this.env.MY_KV // ✅
}
}

⸻

Tooling Rules
• Do not modify worker-configuration.d.ts directly
• To reflect binding changes, run:

npx wrangler types

    •	Ensure tsconfig.json includes the generated file
    •	Linting and CI should fail if interface Env is declared anywhere else

⸻

Migration Guidance 1. Delete env.ts (if it exists) 2. Replace all import { Env } from local paths with the global Env 3. Regenerate types after updating wrangler.toml:

npx wrangler types

⸻

References
• @worker-configuration.d.ts
• @AGENTS.md
